FROM josh5/unmanic:latest

LABEL maintainer="viennej <viennej@github.com>"
LABEL description="Unmanic with Jellyfin FFmpeg 7 upgrade"

# Install Jellyfin FFmpeg 7
RUN \
    echo "**** Install Jellyfin FFmpeg 7 ****" \
        && curl -L https://repo.jellyfin.org/ubuntu/jellyfin_ffmpeg/install-jellyfin-ffmpeg_7.sh | bash \
        && apt-get update \
        && apt-get install -y \
            jellyfin-ffmpeg7 \
    && \
    echo "**** Create symlinks for Jellyfin FFmpeg 7 ****" \
        && ln -sf /usr/lib/jellyfin-ffmpeg/ffmpeg /usr/local/bin/ffmpeg \
        && ln -sf /usr/lib/jellyfin-ffmpeg/ffprobe /usr/local/bin/ffprobe \
    && \
    echo "**** Verify FFmpeg installation ****" \
        && ffmpeg -version | head -1 \
    && \
    echo "**** Section cleanup ****" \
        && apt-get clean autoclean -y \
        && apt-get autoremove -y \
        && rm -rf \
            /var/lib/apt/lists/* \
            /var/tmp/* \
            /tmp/*

# Copy our enhanced AMD codec files
COPY unmanic/libs/unffmpeg/video_codecs/av1.py /app/unmanic/libs/unffmpeg/video_codecs/av1.py
COPY unmanic/libs/unffmpeg/video_codecs/vp9.py /app/unmanic/libs/unffmpeg/video_codecs/vp9.py
COPY unmanic/libs/unffmpeg/hardware_acceleration_handle.py /app/unmanic/libs/unffmpeg/hardware_acceleration_handle.py
COPY unmanic/libs/unffmpeg/video_codecs/h264.py /app/unmanic/libs/unffmpeg/video_codecs/h264.py
COPY unmanic/libs/unffmpeg/video_codecs/hevc.py /app/unmanic/libs/unffmpeg/video_codecs/hevc.py
COPY unmanic/libs/system.py /app/unmanic/libs/system.py

# Set working directory
WORKDIR /app

# Expose port
EXPOSE 8888

# Set entrypoint
ENTRYPOINT ["/init"]